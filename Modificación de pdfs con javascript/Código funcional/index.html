<!-- Importación de la biblioteca jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- Importación de la biblioteca PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>

<!--
  El fragmento de código JavaScript que proporcionaste se utiliza para configurar la ubicación del archivo 
  pdf.worker.min.js necesario para el correcto funcionamiento de la biblioteca PDF.js en el navegador.

  pdfjsLib.GlobalWorkerOptions.workerSrc: Esta línea de código está configurando la ubicación del archivo 
  pdf.worker.min.js que es requerido por PDF.js para procesar y renderizar archivos PDF en el navegador.

  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js": Esta URL especifica la ubicación en 
  línea del archivo pdf.worker.min.js necesario para PDF.js. Se está cargando desde el servidor de Cloudflare.
  -->
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js";
</script>

<!-- Importación de la biblioteca Fabric.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.3.0/fabric.min.js"></script>

<!-- Importación de la biblioteca jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.2.0/jspdf.umd.min.js"></script>

<script>
  /* Constructor del objeto PDFAnnotate, encargado de mostrar el pdf y ofrecer las funciones */
  /*
    container_id: id del elemento contenedor HTML
    url: url del pdf que se va a mostrar
    options: objeto de opciones de configuración adicionales
  */
  var PDFAnnotate = function (container_id, url, options = {}) {
    //Variables de la función
    this.number_of_pages = 0;
    this.pages_rendered = 0;
    this.active_tool = 0;
    this.fabricObjects = [];
    this.fabricObjectsData = [];
    this.color = "rgba(33, 33, 33, 1)";
    this.font_size = 25;
    this.active_canvas = 0;
    this.container_id = container_id;
    this.url = url;
    this.anterior = "rgba(33, 33, 33, 1)";
    this.resaltador_last = false;

    //Variables de estado las herramientas
    //this.second_click_pencil1 = false;
    //this.second_click_pencil2 = false;
    //this.second_click_text = false;

    // Variable que hace referencia al objeto actual PDFAnnotate
    var current_PDFAnnotate = this;

    //Establece un nivel de compresión del documento
    if (options.pageImageCompression) {
      this.pageImageCompression = options.pageImageCompression.toUpperCase();
    } else {
      this.pageImageCompression = "NONE";
    }

    //Carga el documento con una promesa
    var loadingTask = pdfjsLib.getDocument(this.url);

    //Código cuando la promesa se cumple satisfactoriamente
    loadingTask.promise.then(
      function (pdf) {
        //Opción de escalamiento del pdf
        var scale;
        if (options.scale) {
          scale = options.scale;
        } else {
          scale = 1.3;
        }

        //Número de páginas del pdf
        current_PDFAnnotate.number_of_pages = pdf.numPages;

        //Renderización página por página del documento en un canvas dentro del HTML
        for (var i = 1; i <= pdf.numPages; i++) {
          pdf.getPage(i).then(function (page) {
            var viewport = page.getViewport({ scale: scale });
            var canvas = document.createElement("canvas");
            document
              .getElementById(current_PDFAnnotate.container_id)
              .appendChild(canvas);
            canvas.className = "pdf-canvas";
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            context = canvas.getContext("2d");

            var renderContext = {
              canvasContext: context,
              viewport: viewport,
            };
            var renderTask = page.render(renderContext);

            //Se inicializa la biblioteca Fabric.js para poder generar anotaciones en el pdf
            renderTask.promise.then(function () {
              $(".pdf-canvas").each(function (index, el) {
                $(el).attr("id", "page-" + (index + 1) + "-canvas");
              });
              current_PDFAnnotate.pages_rendered++;
              if (
                current_PDFAnnotate.pages_rendered ==
                current_PDFAnnotate.number_of_pages
              )
                current_PDFAnnotate.initFabric();
            });
          });
        }
      },
      //Si hay algún error, se imprime el error
      function (reason) {
        console.error(reason);
      }
    );

    //Se inicializa el objeto de la biblioteca fabric.js para cada página renderizada del pdf.
    this.initFabric = function () {
      var current_PDFAnnotate = this;
      let canvases = $("#" + current_PDFAnnotate.container_id + " canvas");

      canvases.each(function (index, el) {
        var background = el.toDataURL("image/png");

        //Se establece el objeto del pincel para cada página del pdf
        var fabricObj = new fabric.Canvas(el.id, {
          freeDrawingBrush: {
            width: 3,
            color: current_PDFAnnotate.color,
          },
          isDrawingMode: true,
        });
        current_PDFAnnotate.fabricObjects.push(fabricObj);

        $.each(current_PDFAnnotate.fabricObjects, function (index, fabricObj) {
          fabricObj.freeDrawingBrush.width = 3;
        });

        //Guarda los objetos creados dentro cada página
        if (typeof options.onPageUpdated == "function") {
          fabricObj.on("object:added", function () {
            var oldValue = Object.assign(
              {},
              current_PDFAnnotate.fabricObjectsData[index]
            );
            current_PDFAnnotate.fabricObjectsData[index] = fabricObj.toJSON();
            options.onPageUpdated(
              index + 1,
              oldValue,
              current_PDFAnnotate.fabricObjectsData[index]
            );
          });
        }
        //Renderiza cada página con los cambios hechos con Fabric
        fabricObj.setBackgroundImage(
          background,
          fabricObj.renderAll.bind(fabricObj)
        );
        //Añdir objetos tipo texto haciendo click
        $(fabricObj.upperCanvasEl).on("click touchstart", function (event) {
          current_PDFAnnotate.active_canvas = index;
          current_PDFAnnotate.fabricClickHandler(event, fabricObj);
        });
        //Esto garantiza que cualquier cambio que se haga en el lienzo se guarde.
        fabricObj.on("after:render", function () {
          current_PDFAnnotate.fabricObjectsData[index] = fabricObj.toJSON();
          fabricObj.off("after:render");
        });

        //Finaliza exitosamente el renderizado
        if (
          index === canvases.length - 1 &&
          typeof options.ready === "function"
        ) {
          options.ready();
        }
      });
    };

    //Función para añadir los objetos tipo texto y el borrador
    this.fabricClickHandler = function (event, fabricObj) {
      var current_PDFAnnotate = this;

      // Obtener las coordenadas del evento (clic o toque)
      var x, y;
      if (event.type === "click") {
        x = event.clientX;
        y = event.clientY;
      } else if (event.type === "touchstart") {
        // Obtener la primera posición de toque
        x = event.touches[0].clientX;
        y = event.touches[0].clientY;
      }

      if (current_PDFAnnotate.active_tool == 2) {
        var text = new fabric.IText("Escribe acá", {
          left: x - fabricObj.upperCanvasEl.getBoundingClientRect().left,
          top: y - fabricObj.upperCanvasEl.getBoundingClientRect().top,
          fill: current_PDFAnnotate.color,
          fontSize: current_PDFAnnotate.font_size,
          selectable: true,
        });
        fabricObj.add(text);
        current_PDFAnnotate.active_tool = 0;
        var boton = document.getElementById("hand");
        boton.click();
      } else {
        if (current_PDFAnnotate.active_tool == 3) {
          var targetObject = fabricObj.findTarget(event, {
            includeDefaultValues: false,
          });
          if (targetObject) {
            // Eliminar el objeto del lienzo
            fabricObj.remove(targetObject);
          }
          //current_PDFAnnotate.active_tool = 0; // Cambiar la herramienta activa
          //var boton = document.getElementById("hand");
          //boton.click(); // Simular un clic en el botón "hand" u otra acción que desees
        }
      }
    };
  };

  //Función que cambia la herramienta activa
  function changeActiveTool(event) {
    if ($(event.target).hasClass("tool-button")) {
      element = $(event.target);
    } else {
      element = $(event.target).parents(".tool-button").first();
    }
    $(".tool-button.active").removeClass("active");
    $(element).addClass("active");
  }
</script>
